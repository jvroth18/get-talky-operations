<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Client Configuration</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f5f6fa;
      min-height: 100vh;
      color: #333;
      font-family: 'Inter', sans-serif;
    }
    .card {
      @apply bg-white p-8 rounded-xl shadow-md border border-gray-200 mb-8;
    }
    .form-input {
      @apply w-full p-3 bg-gray-50 rounded-lg text-gray-800 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200;
    }
    .form-label {
      @apply block text-sm font-medium text-gray-700 mb-2;
    }
    .section-title {
      @apply text-xl font-semibold text-purple-600 mb-6 pb-2 border-b border-purple-200;
    }
    .input-group {
      @apply mb-6 last:mb-0;
    }
    .table-container {
      @apply overflow-x-auto mt-4;
    }
    .data-table {
      @apply min-w-full divide-y divide-gray-200;
    }
    .data-table th {
      @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
    }
    .data-table td {
      @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
    }
    .data-table tr:nth-child(even) {
      @apply bg-gray-50;
    }
    .add-button {
      @apply mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm font-medium transition-colors duration-200;
    }
    .delete-button {
      @apply text-red-600 hover:text-red-800 transition-colors duration-200;
    }
    .entity-section {
      @apply bg-white rounded-xl shadow-md border border-gray-200 mb-8 overflow-hidden;
    }
    .entity-header {
      @apply bg-purple-600 text-white px-8 py-4 flex justify-between items-center;
    }
    .entity-content {
      @apply p-8;
    }
    .entity-title {
      @apply text-xl font-semibold;
    }
    .add-entity-btn {
      @apply bg-white text-purple-600 px-4 py-2 rounded-lg flex items-center space-x-2 text-sm font-medium 
             hover:bg-purple-50 transition-colors duration-200;
    }
    .data-table {
      @apply w-full border-collapse;
    }
    .data-table th {
      @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200;
    }
    .data-table td {
      @apply px-6 py-4 text-sm text-gray-900 border-b border-gray-100;
    }
    .data-table tbody tr:hover {
      @apply bg-gray-50;
    }
    .delete-btn {
      @apply text-red-600 hover:text-red-800 font-medium cursor-pointer;
    }
    .modal {
      @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
    }
    .modal-content {
      @apply bg-white rounded-xl shadow-xl w-full max-w-lg p-8 relative;
    }
    .modal-close {
      @apply absolute top-4 right-4 text-gray-400 hover:text-gray-600 cursor-pointer;
    }
  </style>
</head>
<body class="p-6 bg-gray-50 pb-24">
  <!-- Notification Element -->
  <div
    id="notification"
    class="hidden fixed top-6 right-6 p-4 rounded-lg bg-purple-600 text-white shadow-md transform transition-all duration-300"
  ></div>

  <div class="max-w-6xl mx-auto">
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <button
          onclick="window.location.href='/'"
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center transition-colors duration-200"
        >
          ← Back
        </button>
        <h1 class="text-3xl font-bold text-purple-600">
          Edit Client Configuration
        </h1>
        <div class="w-24"></div>
      </div>
    </header>

    <!-- Main Configuration -->
    <div class="card">
      <h2 class="section-title">Configuration Details</h2>
      <form id="edit-config-form" class="space-y-6">
        <input type="hidden" id="edit-config-id" />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="input-group">
            <label class="form-label" for="edit-config-name">Client Name</label>
            <input
              type="text"
              id="edit-config-name"
              class="form-input"
              required
              placeholder="Enter Client Name"
            />
          </div>

          <div class="input-group">
            <label class="form-label" for="edit-client-id">Client ID (UUID)</label>
            <input
              type="text"
              id="edit-client-id"
              class="form-input bg-gray-100"
              readonly
              placeholder="Auto-generated UUID"
            />
          </div>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-client-type">Client Type</label>
          <select id="edit-client-type" class="form-input" required>
            <!-- Populated dynamically -->
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="input-group">
            <label class="form-label" for="edit-elevenlabs-model">ElevenLabs Model</label>
            <input
              type="text"
              id="edit-elevenlabs-model"
              class="form-input"
              placeholder="Enter Model"
            />
          </div>

          <div class="input-group">
            <label class="form-label" for="edit-elevenlabs-voice">ElevenLabs Voice ID</label>
            <input
              type="text"
              id="edit-elevenlabs-voice"
              class="form-input"
              placeholder="Enter Voice ID"
            />
          </div>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-client-internal-id">Client Internal ID</label>
          <input
            type="text"
            id="edit-client-internal-id"
            class="form-input"
            placeholder="Enter Internal ID"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="input-group">
            <label class="form-label" for="edit-twilio-phone-number">Twilio Phone Number</label>
            <input
              type="text"
              id="edit-twilio-phone-number"
              class="form-input"
              placeholder="Enter Twilio Phone Number"
            />
          </div>
          <div class="input-group">
            <label class="form-label" for="edit-twilio-phone-number-sid">Twilio Phone Number SID</label>
            <input
              type="text"
              id="edit-twilio-phone-number-sid"
              class="form-input"
              placeholder="Enter Twilio Phone Number SID"
            />
          </div>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-about-us">About Us</label>
          <textarea
            id="edit-about-us"
            class="form-input"
            rows="4"
            placeholder="Enter About Us"
          ></textarea>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-services">Services</label>
          <textarea
            id="edit-services"
            class="form-input"
            rows="4"
            placeholder="Enter Services"
          ></textarea>
        </div>
      </form>
    </div>

    <!-- Providers Section -->
    <div class="entity-section" id="providers-section">
      <div class="entity-header">
        <h2 class="entity-title">Providers</h2>
        <button class="add-entity-btn" onclick="showAddProviderModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Provider</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Provider Type</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="providers-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Request Types Section -->
    <div class="entity-section" id="request-types-section">
      <div class="entity-header">
        <h2 class="entity-title">Request Types</h2>
        <button class="add-entity-btn" onclick="showAddRequestTypeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Request Type</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Length</th>
                <th>Display Order</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="request-types-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Locations Section -->
    <div class="entity-section" id="locations-section">
      <div class="entity-header">
        <h2 class="entity-title">Locations</h2>
        <button class="add-entity-btn" onclick="showAddLocationModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Location</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Operating Hours</th>
                <th>Address</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="locations-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- API Keys Section -->
    <div class="entity-section" id="api-keys-section">
      <div class="entity-header">
        <h2 class="entity-title">API Keys</h2>
        <button class="add-entity-btn" onclick="showAddApiKeyModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add API Key</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>API Key</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="api-keys-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="entity-section" id="users-section">
      <div class="entity-header">
        <h2 class="entity-title">Users</h2>
        <button class="add-entity-btn" onclick="showAddUserModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add User</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Update Configuration Button -->
    <div class="fixed bottom-6 right-6 left-6 z-40">
      <div class="max-w-6xl mx-auto">
        <button 
          id="update-config-btn"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 px-6 rounded-xl font-medium 
                 transition-colors duration-200 flex items-center justify-center space-x-2 shadow-lg"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>Update Configuration</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Templates -->
  <!-- Provider Modal -->
  <div id="provider-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('provider-modal')">×</button>
      <h3 class="text-xl font-semibold mb-4">Add Provider</h3>
      <form id="add-provider-form" class="space-y-4">
        <div>
          <label class="form-label">First Name</label>
          <input type="text" name="first_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Last Name</label>
          <input type="text" name="last_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Provider Type</label>
          <select name="provider_type_id" class="form-input" required>
            <!-- Populated dynamically -->
          </select>
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" name="phone_number" class="form-input">
        </div>
        <div>
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-input">
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('provider-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add Provider</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Request Type Modal -->
  <div id="request-type-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('request-type-modal')">×</button>
      <h3 class="text-xl font-semibold mb-4">Add Request Type</h3>
      <form id="add-request-type-form" class="space-y-4">
        <div>
          <label class="form-label">Name</label>
          <input type="text" name="name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Description</label>
          <input type="text" name="description" class="form-input">
        </div>
        <div>
          <label class="form-label">Length (minutes)</label>
          <input type="number" name="length" class="form-input">
        </div>
        <div>
          <label class="form-label">Display Order</label>
          <input type="number" name="display_order" class="form-input">
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('request-type-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add Request Type</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Location Modal -->
  <div id="location-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('location-modal')">×</button>
      <h3 class="text-xl font-semibold mb-4">Add Location</h3>
      <form id="add-location-form" class="space-y-4">
        <div>
          <label class="form-label">Name</label>
          <input type="text" name="name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" name="phone_number" class="form-input">
        </div>
        <div>
          <label class="form-label">Operating Hours</label>
          <input type="text" name="operating_hours" class="form-input">
        </div>
        <div>
          <label class="form-label">Address</label>
          <input type="text" name="address" class="form-input">
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('location-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add Location</button>
        </div>
      </form>
    </div>
  </div>

  <!-- API Key Modal -->
  <div id="api-key-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('api-key-modal')">×</button>
      <h3 class="text-xl font-semibold mb-4">Add API Key</h3>
      <form id="add-api-key-form" class="space-y-4">
        <div>
          <label class="form-label">Name</label>
          <input type="text" name="name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">API Key</label>
          <input type="text" name="api_key" class="form-input" required>
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('api-key-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add API Key</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Modal -->
  <div id="user-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('user-modal')">×</button>
      <h3 class="text-xl font-semibold mb-4">Add User</h3>
      <form id="add-user-form" class="space-y-4">
        <div>
          <label class="form-label">First Name</label>
          <input type="text" name="first_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Last Name</label>
          <input type="text" name="last_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" name="phone_number" class="form-input">
        </div>
        <div>
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-input">
        </div>
        <div>
          <label class="form-label">Role</label>
          <select name="role_id" class="form-input" required>
            <!-- Populated dynamically -->
          </select>
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('user-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add User</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global configuration ID
    let configId;

    // API Base URL
    const API_BASE_URL = ''; // Adjust if needed

    // Utility function to show notifications
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `fixed top-6 right-6 p-4 rounded-lg ${
        isError ? 'bg-red-500' : 'bg-purple-600'
      } text-white shadow-md transform transition-all duration-300`;
      notification.style.display = 'block';
      setTimeout(() => (notification.style.display = 'none'), 3000);
    }

    // Generic API call function
    async function apiCall(endpoint, method = 'GET', data = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' },
        };
        if (data) options.body = JSON.stringify(data);
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        throw error;
      }
    }

    // Store entities locally
    let localData = {
      providers: [],
      requestTypes: [],
      locations: [],
      apiKeys: [],
      users: []
    };

    // Show/Hide Modal Functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Add Entity Functions
    async function addProvider(data) {
      try {
        console.log('Adding provider with data:', data);
        const response = await apiCall('/providers/', 'POST', {
          configuration_id: configId,
          first_name: data.first_name,
          last_name: data.last_name,
          phone_number: data.phone_number || undefined,
          email: data.email || undefined,
          provider_type_id: parseInt(data.provider_type_id) || undefined
        });
        localData.providers.push(response);
        await loadProviders(configId);
        hideModal('provider-modal');
        showNotification('Provider added successfully!');
      } catch (error) {
        console.error('Failed to add provider:', error);
        showNotification('Failed to add provider: ' + error.message, true);
      }
    }

    async function addRequestType(data) {
      try {
        const response = await apiCall('/request_types/', 'POST', { ...data, configuration_id: configId });
        localData.requestTypes.push(response);
        await loadRequestTypes(configId);
        hideModal('request-type-modal');
        showNotification('Request type added successfully!');
      } catch (error) {
        showNotification('Failed to add request type: ' + error.message, true);
      }
    }

    async function addLocation(data) {
      try {
        const response = await apiCall('/locations/', 'POST', { ...data, configuration_id: configId });
        localData.locations.push(response);
        await loadLocations(configId);
        hideModal('location-modal');
        showNotification('Location added successfully!');
      } catch (error) {
        showNotification('Failed to add location: ' + error.message, true);
      }
    }

    async function addApiKey(data) {
      try {
        const response = await apiCall('/client_api_keys/', 'POST', { ...data, configuration_id: configId });
        localData.apiKeys.push(response);
        await loadApiKeys(configId);
        hideModal('api-key-modal');
        showNotification('API key added successfully!');
      } catch (error) {
        showNotification('Failed to add API key: ' + error.message, true);
      }
    }

    async function addUser(data) {
      try {
        const response = await apiCall('/users/', 'POST', { ...data, configuration_id: configId });
        localData.users.push(response);
        await loadUsers(configId);
        hideModal('user-modal');
        showNotification('User added successfully!');
      } catch (error) {
        showNotification('Failed to add user: ' + error.message, true);
      }
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      configId = urlParams.get('id');
      if (!configId) {
        showNotification('No configuration ID specified.', true);
        return;
      }

      try {
        // Load client types for dropdown
        const clientTypes = await apiCall('/client-type/');
        const dropdown = document.getElementById('edit-client-type');
        dropdown.innerHTML = `
          <option value="">Select a client type</option>
          ${clientTypes.map(type => `<option value="${type.id}">${type.name}</option>`).join('')}
        `;

        // Load configuration data
        const config = await apiCall(`/configurations/${configId}`);
        console.log('Loaded configuration:', config);

        // Populate main form
        document.getElementById('edit-config-id').value = config.id;
        document.getElementById('edit-client-id').value = config.client_id || '';
        document.getElementById('edit-config-name').value = config.name || '';
        document.getElementById('edit-client-type').value = config.client_type_id || '';
        document.getElementById('edit-elevenlabs-model').value = config.elevenlabs_model || '';
        document.getElementById('edit-elevenlabs-voice').value = config.elevenlabs_voice_id || '';
        document.getElementById('edit-client-internal-id').value = config.client_internal_id || '';
        document.getElementById('edit-twilio-phone-number').value = config.twilio_phone_number || '';
        document.getElementById('edit-twilio-phone-number-sid').value = config.twilio_phone_number_sid || '';
        document.getElementById('edit-about-us').value = config.about_us || '';
        document.getElementById('edit-services').value = config.services || '';

        // Load related entities
        await Promise.all([
          loadProviders(configId),
          loadRequestTypes(configId),
          loadLocations(configId),
          loadApiKeys(configId),
          loadUsers(configId)
        ]);

        // Add update configuration handler
        document.getElementById('update-config-btn').addEventListener('click', async () => {
          try {
            const updatedConfig = {
              name: document.getElementById('edit-config-name').value,
              client_type_id: parseInt(document.getElementById('edit-client-type').value),
              elevenlabs_model: document.getElementById('edit-elevenlabs-model').value,
              elevenlabs_voice_id: document.getElementById('edit-elevenlabs-voice').value,
              client_internal_id: document.getElementById('edit-client-internal-id').value,
              twilio_phone_number: document.getElementById('edit-twilio-phone-number').value,
              twilio_phone_number_sid: document.getElementById('edit-twilio-phone-number-sid').value,
              about_us: document.getElementById('edit-about-us').value,
              services: document.getElementById('edit-services').value
            };

            await apiCall(`/configurations/${configId}`, 'PUT', updatedConfig);
            showNotification('Configuration updated successfully!');
          } catch (error) {
            showNotification('Failed to update configuration: ' + error.message, true);
          }
        });

      } catch (err) {
        console.error('Initialization error:', err);
        showNotification('Failed to initialize: ' + err.message, true);
      }

      // Add form submission handlers
      document.getElementById('add-provider-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        console.log('Provider form data:', data);
        await addProvider(data);
      });

      document.getElementById('add-request-type-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addRequestType(Object.fromEntries(formData));
      });

      document.getElementById('add-location-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addLocation(Object.fromEntries(formData));
      });

      document.getElementById('add-api-key-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addApiKey(Object.fromEntries(formData));
      });

      document.getElementById('add-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addUser(Object.fromEntries(formData));
      });

      // Load user roles for the user modal
      try {
        const userRoles = await apiCall('/user-role/');
        const roleSelect = document.querySelector('#user-modal select[name="role_id"]');
        roleSelect.innerHTML = userRoles
          .map(role => `<option value="${role.id}">${role.name}</option>`)
          .join('');
      } catch (error) {
        showNotification('Failed to load user roles: ' + error.message, true);
      }
    });

    // Functions to load related entities
    async function loadProviders(configId) {
      try {
        const response = await fetch(`/providers/${configId}`);
        if (!response.ok) throw new Error('Failed to fetch providers');
        const providers = await response.json();
        localData.providers = providers;
        
        // Get provider types for mapping
        const providerTypesResponse = await fetch('/provider-type/');
        if (!providerTypesResponse.ok) throw new Error('Failed to fetch provider types');
        const providerTypes = await providerTypesResponse.json();
        const providerTypeMap = Object.fromEntries(providerTypes.map(type => [type.id, type.name]));
        
        const tbody = document.getElementById('providers-list');
        tbody.innerHTML = providers.map(provider => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${provider.first_name} ${provider.last_name}</td>
            <td class="px-6 py-4">${provider.provider_type_id ? providerTypeMap[provider.provider_type_id] : '-'}</td>
            <td class="px-6 py-4">${provider.phone_number || '-'}</td>
            <td class="px-6 py-4">${provider.email || '-'}</td>
            <td class="px-6 py-4">
              <button onclick="deleteProvider(${provider.id})" 
                      class="text-red-600 hover:text-red-800 font-medium">
                Delete
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading providers:', error);
        showNotification('Error loading providers: ' + error.message, true);
      }
    }

    async function loadRequestTypes(configId) {
      try {
        const response = await fetch(`/request_types/${configId}`);
        if (!response.ok) throw new Error('Failed to fetch request types');
        const requestTypes = await response.json();
        localData.requestTypes = requestTypes;
        
        const tbody = document.getElementById('request-types-list');
        tbody.innerHTML = requestTypes.map(type => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${type.name}</td>
            <td class="px-6 py-4">${type.description || '-'}</td>
            <td class="px-6 py-4">${type.length || '-'}</td>
            <td class="px-6 py-4">${type.display_order || '-'}</td>
            <td class="px-6 py-4">
              <button onclick="deleteRequestType(${type.id})" 
                      class="text-red-600 hover:text-red-800 font-medium">
                Delete
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showNotification('Error loading request types: ' + error.message, true);
      }
    }

    async function loadLocations(configId) {
      try {
        const response = await fetch(`/locations/${configId}`);
        if (!response.ok) throw new Error('Failed to fetch locations');
        const locations = await response.json();
        localData.locations = locations;
        
        const tbody = document.getElementById('locations-list');
        tbody.innerHTML = locations.map(location => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${location.name}</td>
            <td class="px-6 py-4">${location.phone_number || '-'}</td>
            <td class="px-6 py-4">${location.operating_hours || '-'}</td>
            <td class="px-6 py-4">${location.address || '-'}</td>
            <td class="px-6 py-4">
              <button onclick="deleteLocation(${location.id})" 
                      class="text-red-600 hover:text-red-800 font-medium">
                Delete
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showNotification('Error loading locations: ' + error.message, true);
      }
    }

    async function loadApiKeys(configId) {
      try {
        const response = await fetch(`/client_api_keys/${configId}`);
        if (!response.ok) throw new Error('Failed to fetch API keys');
        const apiKeys = await response.json();
        localData.apiKeys = apiKeys;
        
        const tbody = document.getElementById('api-keys-list');
        tbody.innerHTML = apiKeys.map(key => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${key.name}</td>
            <td class="px-6 py-4">${key.api_key}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 rounded-full text-xs font-medium
                         ${key.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${key.active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4">
              <button onclick="deleteApiKey(${key.id})" 
                      class="text-red-600 hover:text-red-800 font-medium">
                Delete
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showNotification('Error loading API keys: ' + error.message, true);
      }
    }

    async function loadUsers(configId) {
      try {
        const response = await fetch(`/users/${configId}`);
        if (!response.ok) throw new Error('Failed to fetch users');
        const users = await response.json();
        localData.users = users;
        
        const tbody = document.getElementById('users-list');
        tbody.innerHTML = users.map(user => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${user.first_name} ${user.last_name}</td>
            <td class="px-6 py-4">${user.phone_number || '-'}</td>
            <td class="px-6 py-4">${user.email || '-'}</td>
            <td class="px-6 py-4">${user.role?.name || '-'}</td>
            <td class="px-6 py-4">
              <button onclick="deleteUser(${user.id})" 
                      class="text-red-600 hover:text-red-800 font-medium">
                Delete
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showNotification('Error loading users: ' + error.message, true);
      }
    }

    // Delete functions for related entities
    async function deleteProvider(id) {
      if (!confirm('Are you sure you want to delete this provider?')) return;
      
      try {
        const response = await fetch(`/providers/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete provider');
        await loadProviders(configId);
        showNotification('Provider deleted successfully');
      } catch (error) {
        showNotification('Failed to delete provider: ' + error.message, true);
      }
    }

    async function deleteRequestType(id) {
      if (!confirm('Are you sure you want to delete this request type?')) return;
      
      try {
        const response = await fetch(`/request_types/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete request type');
        await loadRequestTypes(configId);
        showNotification('Request type deleted successfully');
      } catch (error) {
        showNotification('Failed to delete request type: ' + error.message, true);
      }
    }

    async function deleteLocation(id) {
      if (!confirm('Are you sure you want to delete this location?')) return;
      
      try {
        const response = await fetch(`/locations/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete location');
        await loadLocations(configId);
        showNotification('Location deleted successfully');
      } catch (error) {
        showNotification('Failed to delete location: ' + error.message, true);
      }
    }

    async function deleteApiKey(id) {
      if (!confirm('Are you sure you want to delete this API key?')) return;
      
      try {
        const response = await fetch(`/client_api_keys/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete API key');
        await loadApiKeys(configId);
        showNotification('API key deleted successfully');
      } catch (error) {
        showNotification('Failed to delete API key: ' + error.message, true);
      }
    }

    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      
      try {
        const response = await fetch(`/users/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete user');
        await loadUsers(configId);
        showNotification('User deleted successfully');
      } catch (error) {
        showNotification('Failed to delete user: ' + error.message, true);
      }
    }

    // Modal trigger functions
    function showAddProviderModal() {
      // Refresh provider types before showing modal
      loadProviderTypes().then(() => {
        showModal('provider-modal');
      }).catch(error => {
        console.error('Error loading provider types:', error);
        showNotification('Failed to load provider types', true);
      });
    }

    // Function to load provider types
    async function loadProviderTypes() {
      try {
        const response = await fetch('/provider-type/');
        if (!response.ok) throw new Error('Failed to fetch provider types');
        const providerTypes = await response.json();
        
        const providerTypeSelect = document.querySelector('#provider-modal select[name="provider_type_id"]');
        if (providerTypeSelect) {
          providerTypeSelect.innerHTML = `
            <option value="">Select a provider type</option>
            ${providerTypes.map(type => `<option value="${type.id}">${type.name}</option>`).join('')}
          `;
        } else {
          throw new Error('Provider type select element not found');
        }
      } catch (error) {
        console.error('Error loading provider types:', error);
        throw error;
      }
    }

    function showAddRequestTypeModal() {
      showModal('request-type-modal');
    }

    function showAddLocationModal() {
      showModal('location-modal');
    }

    function showAddApiKeyModal() {
      showModal('api-key-modal');
    }

    function showAddUserModal() {
      showModal('user-modal');
    }
  </script>
</body>
</html>
