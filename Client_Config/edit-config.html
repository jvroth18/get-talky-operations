<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Client Configuration</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f5f6fa;
      min-height: 100vh;
      color: #333;
      font-family: 'Inter', sans-serif;
    }
    .card {
      @apply bg-white p-8 rounded-xl shadow-md border border-gray-200 mb-8;
    }
    .form-input {
      @apply w-full p-3 bg-gray-50 rounded-lg text-gray-800 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200;
    }
    .form-label {
      @apply block text-sm font-medium text-gray-700 mb-2;
    }
    .section-title {
      @apply text-xl font-semibold text-purple-600 mb-6 pb-2 border-b border-purple-200;
    }
    .input-group {
      @apply mb-6 last:mb-0;
    }
    .table-container {
      @apply overflow-x-auto mt-4;
    }
    .data-table {
      @apply min-w-full divide-y divide-gray-200;
    }
    .data-table th {
      @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
    }
    .data-table td {
      @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
    }
    .data-table tr:nth-child(even) {
      @apply bg-gray-50;
    }
    .add-button {
      @apply mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm font-medium transition-colors duration-200;
    }
    .delete-button {
      @apply text-red-600 hover:text-red-800 transition-colors duration-200;
    }
    .entity-section {
      @apply bg-white rounded-xl shadow-md border border-gray-200 mb-8 overflow-hidden;
    }
    .entity-header {
      @apply bg-purple-600 text-white px-8 py-4 flex justify-between items-center;
    }
    .entity-content {
      @apply p-8;
    }
    .entity-title {
      @apply text-xl font-semibold;
    }
    .add-entity-btn {
      @apply bg-white text-purple-600 px-4 py-2 rounded-lg flex items-center space-x-2 text-sm font-medium 
             hover:bg-purple-50 transition-colors duration-200;
    }
    .data-table {
      @apply w-full border-collapse;
    }
    .data-table th {
      @apply px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200;
    }
    .data-table td {
      @apply px-6 py-4 text-sm text-gray-900 border-b border-gray-100;
    }
    .data-table tbody tr:hover {
      @apply bg-gray-50;
    }
    .delete-btn {
      @apply text-red-600 hover:text-red-800 font-medium cursor-pointer;
    }
    .modal {
      @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden;
    }
    .modal-content {
      @apply bg-white rounded-xl shadow-xl w-full max-w-lg p-8;
    }
  </style>
</head>
<body class="p-6 bg-gray-50">
  <!-- Notification Element -->
  <div
    id="notification"
    class="hidden fixed top-6 right-6 p-4 rounded-lg bg-purple-600 text-white shadow-md transform transition-all duration-300"
  ></div>

  <div class="max-w-6xl mx-auto">
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <button
          onclick="window.location.href='/'"
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center transition-colors duration-200"
        >
          ‚Üê Back
        </button>
        <h1 class="text-3xl font-bold text-purple-600">
          Edit Client Configuration
        </h1>
        <div class="w-24"></div>
      </div>
    </header>

    <!-- Main Configuration -->
    <div class="card">
      <h2 class="section-title">Configuration Details</h2>
      <form id="edit-config-form" class="space-y-6">
        <input type="hidden" id="edit-config-id" />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="input-group">
            <label class="form-label" for="edit-config-name">Client Name</label>
            <input
              type="text"
              id="edit-config-name"
              class="form-input"
              required
              placeholder="Enter Client Name"
            />
          </div>

          <div class="input-group">
            <label class="form-label" for="edit-client-id">Client ID (UUID)</label>
            <input
              type="text"
              id="edit-client-id"
              class="form-input bg-gray-100"
              readonly
              placeholder="Auto-generated UUID"
            />
          </div>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-client-type">Client Type</label>
          <select id="edit-client-type" class="form-input" required>
            <!-- Populated dynamically -->
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="input-group">
            <label class="form-label" for="edit-elevenlabs-model">ElevenLabs Model</label>
            <input
              type="text"
              id="edit-elevenlabs-model"
              class="form-input"
              placeholder="Enter Model"
            />
          </div>

          <div class="input-group">
            <label class="form-label" for="edit-elevenlabs-voice">ElevenLabs Voice ID</label>
            <input
              type="text"
              id="edit-elevenlabs-voice"
              class="form-input"
              placeholder="Enter Voice ID"
            />
          </div>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-client-internal-id">Client Internal ID</label>
          <input
            type="text"
            id="edit-client-internal-id"
            class="form-input"
            placeholder="Enter Internal ID"
          />
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-about-us">About Us</label>
          <textarea
            id="edit-about-us"
            class="form-input"
            rows="4"
            placeholder="Enter About Us"
          ></textarea>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-services">Services</label>
          <textarea
            id="edit-services"
            class="form-input"
            rows="4"
            placeholder="Enter Services"
          ></textarea>
        </div>

        <div class="input-group">
          <label class="form-label" for="edit-locations-text">Locations</label>
          <textarea
            id="edit-locations-text"
            class="form-input"
            rows="4"
            placeholder="Enter Locations"
          ></textarea>
        </div>

        <div class="pt-6 border-t border-gray-200">
          <button 
            type="submit" 
            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>Update Configuration</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Providers Section -->
    <div class="entity-section" id="providers-section">
      <div class="entity-header">
        <h2 class="entity-title">Providers</h2>
        <button class="add-entity-btn" onclick="showAddProviderModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Provider</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="providers-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Request Types Section -->
    <div class="entity-section" id="request-types-section">
      <div class="entity-header">
        <h2 class="entity-title">Request Types</h2>
        <button class="add-entity-btn" onclick="showAddRequestTypeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Request Type</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Length</th>
                <th>Display Order</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="request-types-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Locations Section -->
    <div class="entity-section" id="locations-section">
      <div class="entity-header">
        <h2 class="entity-title">Locations</h2>
        <button class="add-entity-btn" onclick="showAddLocationModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add Location</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Operating Hours</th>
                <th>Address</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="locations-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- API Keys Section -->
    <div class="entity-section" id="api-keys-section">
      <div class="entity-header">
        <h2 class="entity-title">API Keys</h2>
        <button class="add-entity-btn" onclick="showAddApiKeyModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add API Key</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>API Key</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="api-keys-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="entity-section" id="users-section">
      <div class="entity-header">
        <h2 class="entity-title">Users</h2>
        <button class="add-entity-btn" onclick="showAddUserModal()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
          </svg>
          <span>Add User</span>
        </button>
      </div>
      <div class="entity-content">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Update Configuration Button -->
    <div class="fixed bottom-6 right-6 left-6">
      <div class="max-w-6xl mx-auto">
        <button 
          id="update-config-btn"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 px-6 rounded-xl font-medium 
                 transition-colors duration-200 flex items-center justify-center space-x-2 shadow-lg"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span>Update Configuration</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Templates -->
  <div id="provider-modal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-semibold mb-4">Add Provider</h3>
      <form id="add-provider-form" class="space-y-4">
        <div>
          <label class="form-label">First Name</label>
          <input type="text" name="first_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Last Name</label>
          <input type="text" name="last_name" class="form-input" required>
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" name="phone_number" class="form-input">
        </div>
        <div>
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-input">
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" onclick="hideModal('provider-modal')">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Add Provider</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Similar modals for other entities -->

  <script>
    // Store entities locally
    let localData = {
      providers: [],
      requestTypes: [],
      locations: [],
      apiKeys: [],
      users: []
    };

    // Show/Hide Modal Functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Add Entity Functions
    async function addProvider(data) {
      try {
        const response = await apiCall('/providers/', 'POST', { ...data, configuration_id: configId });
        localData.providers.push(response);
        await loadProviders(configId);
        hideModal('provider-modal');
        showNotification('Provider added successfully!');
      } catch (error) {
        showNotification('Failed to add provider: ' + error.message, true);
      }
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const configId = urlParams.get('id');
      if (!configId) {
        showNotification('No configuration ID specified.', true);
        return;
      }

      try {
        const clientTypes = await apiCall('/client-type/');
        const dropdown = document.getElementById('edit-client-type');
        dropdown.innerHTML = clientTypes
          .map((t) => `<option value="${t.id}">${t.name}</option>`)
          .join('');

        const config = await apiCall(`/configurations/${configId}`);

        // Populate main form
        document.getElementById('edit-config-id').value = config.id;
        document.getElementById('edit-client-id').value = config.client_id || '';
        document.getElementById('edit-config-name').value = config.name || '';
        document.getElementById('edit-client-type').value = config.client_type_id || '';
        document.getElementById('edit-elevenlabs-model').value = config.elevenlabs_model || '';
        document.getElementById('edit-elevenlabs-voice').value = config.elevenlabs_voice_id || '';
        document.getElementById('edit-client-internal-id').value = config.client_internal_id || '';
        document.getElementById('edit-about-us').value = config.about_us || '';
        document.getElementById('edit-services').value = config.services || '';
        document.getElementById('edit-locations-text').value = config.locations || '';

        // Load related entities
        await Promise.all([
          loadProviders(configId),
          loadRequestTypes(configId),
          loadLocations(configId),
          loadApiKeys(configId),
          loadUsers(configId)
        ]);

      } catch (err) {
        showNotification('Failed to load configuration: ' + err.message, true);
      }

      // Move update configuration logic to bottom button
      document.getElementById('update-config-btn').addEventListener('click', async () => {
        const formData = {
          name: document.getElementById('edit-config-name').value,
          client_type_id: parseInt(document.getElementById('edit-client-type').value),
          elevenlabs_model: document.getElementById('edit-elevenlabs-model').value || undefined,
          elevenlabs_voice_id: document.getElementById('edit-elevenlabs-voice').value || undefined,
          client_internal_id: document.getElementById('edit-client-internal-id').value || undefined,
          about_us: document.getElementById('edit-about-us').value || undefined,
          services: document.getElementById('edit-services').value || undefined,
          locations: document.getElementById('edit-locations-text').value || undefined,
        };

        try {
          await apiCall(`/configurations/${configId}`, 'PUT', formData);
          
          // Update related entities
          await Promise.all([
            ...localData.providers.map(p => apiCall('/providers/', 'POST', { ...p, configuration_id: configId })),
            ...localData.requestTypes.map(r => apiCall('/request_types/', 'POST', { ...r, configuration_id: configId })),
            ...localData.locations.map(l => apiCall('/locations/', 'POST', { ...l, configuration_id: configId })),
            ...localData.apiKeys.map(k => apiCall('/client_api_keys/', 'POST', { ...k, configuration_id: configId })),
            ...localData.users.map(u => apiCall('/users/', 'POST', { ...u, configuration_id: configId }))
          ]);

          showNotification('Configuration and related entities updated successfully!');
        } catch (error) {
          showNotification('Failed to update configuration: ' + error.message, true);
        }
      });

      // Add form submission handlers
      document.getElementById('add-provider-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addProvider(Object.fromEntries(formData));
      });

      // Similar handlers for other entity forms
    });

    // Functions to load related entities
    async function loadProviders(configId) {
      const providers = await apiCall(`/providers/${configId}`);
      const tbody = document.getElementById('providers-list');
      tbody.innerHTML = providers.map(provider => `
        <tr>
          <td>${provider.first_name} ${provider.last_name}</td>
          <td>${provider.phone_number || '-'}</td>
          <td>${provider.email || '-'}</td>
          <td>
            <button onclick="deleteProvider(${provider.id})" class="delete-button">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function loadRequestTypes(configId) {
      const requestTypes = await apiCall(`/request_types/${configId}`);
      const tbody = document.getElementById('request-types-list');
      tbody.innerHTML = requestTypes.map(type => `
        <tr>
          <td>${type.name}</td>
          <td>${type.description || '-'}</td>
          <td>${type.length || '-'}</td>
          <td>${type.display_order || '-'}</td>
          <td>
            <button onclick="deleteRequestType(${type.id})" class="delete-button">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function loadLocations(configId) {
      const locations = await apiCall(`/locations/${configId}`);
      const tbody = document.getElementById('locations-list');
      tbody.innerHTML = locations.map(location => `
        <tr>
          <td>${location.name}</td>
          <td>${location.phone_number || '-'}</td>
          <td>${location.operating_hours || '-'}</td>
          <td>${location.address || '-'}</td>
          <td>
            <button onclick="deleteLocation(${location.id})" class="delete-button">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function loadApiKeys(configId) {
      const apiKeys = await apiCall(`/client_api_keys/${configId}`);
      const tbody = document.getElementById('api-keys-list');
      tbody.innerHTML = apiKeys.map(key => `
        <tr>
          <td>${key.name}</td>
          <td>${key.api_key}</td>
          <td>${key.active ? 'Active' : 'Inactive'}</td>
          <td>
            <button onclick="deleteApiKey(${key.id})" class="delete-button">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function loadUsers(configId) {
      const users = await apiCall(`/users/${configId}`);
      const tbody = document.getElementById('users-list');
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.first_name} ${user.last_name}</td>
          <td>${user.phone_number || '-'}</td>
          <td>${user.email || '-'}</td>
          <td>${user.role?.name || '-'}</td>
          <td>
            <button onclick="deleteUser(${user.id})" class="delete-button">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Delete functions for related entities
    async function deleteProvider(id) {
      try {
        await apiCall(`/providers/${id}`, 'DELETE');
        showNotification('Provider deleted successfully');
        await loadProviders(configId);
      } catch (error) {
        showNotification('Failed to delete provider: ' + error.message, true);
      }
    }

    async function deleteRequestType(id) {
      try {
        await apiCall(`/request_types/${id}`, 'DELETE');
        showNotification('Request type deleted successfully');
        await loadRequestTypes(configId);
      } catch (error) {
        showNotification('Failed to delete request type: ' + error.message, true);
      }
    }

    async function deleteLocation(id) {
      try {
        await apiCall(`/locations/${id}`, 'DELETE');
        showNotification('Location deleted successfully');
        await loadLocations(configId);
      } catch (error) {
        showNotification('Failed to delete location: ' + error.message, true);
      }
    }

    async function deleteApiKey(id) {
      try {
        await apiCall(`/client_api_keys/${id}`, 'DELETE');
        showNotification('API key deleted successfully');
        await loadApiKeys(configId);
      } catch (error) {
        showNotification('Failed to delete API key: ' + error.message, true);
      }
    }

    async function deleteUser(id) {
      try {
        await apiCall(`/users/${id}`, 'DELETE');
        showNotification('User deleted successfully');
        await loadUsers(configId);
      } catch (error) {
        showNotification('Failed to delete user: ' + error.message, true);
      }
    }

    // Modal functions for adding new entities
    // These will be implemented in the next step
    function showAddProviderModal() {
      // TODO: Implement modal for adding provider
    }

    function showAddRequestTypeModal() {
      // TODO: Implement modal for adding request type
    }

    function showAddLocationModal() {
      // TODO: Implement modal for adding location
    }

    function showAddApiKeyModal() {
      // TODO: Implement modal for adding API key
    }

    function showAddUserModal() {
      // TODO: Implement modal for adding user
    }
  </script>
</body>
</html>
